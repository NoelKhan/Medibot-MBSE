/**
 * E2E Tests for MediBot App
 * =========================
 * Critical user flows end-to-end testing
 */

describe('MediBot E2E Tests', () => {
  beforeAll(async () => {
    await device.launchApp({
      newInstance: true,
      permissions: {
        notifications: 'YES',
        camera: 'YES',
      },
    });
  });

  beforeEach(async () => {
    await device.reloadReactNative();
  });

  describe('Authentication Flow', () => {
    it('should display role selection screen on launch', async () => {
      await expect(element(by.text('Select Your Role'))).toBeVisible();
      await expect(element(by.text('Patient'))).toBeVisible();
      await expect(element(by.text('Medical Staff'))).toBeVisible();
      await expect(element(by.text('Emergency Staff'))).toBeVisible();
    });

    it('should navigate to patient login', async () => {
      await element(by.text('Patient')).tap();
      await expect(element(by.text('Patient Login'))).toBeVisible();
      await expect(element(by.id('email-input'))).toBeVisible();
      await expect(element(by.id('password-input'))).toBeVisible();
    });

    it('should login as patient successfully', async () => {
      // Navigate to patient login
      await element(by.text('Patient')).tap();
      
      // Enter credentials
      await element(by.id('email-input')).typeText('patient@test.com');
      await element(by.id('password-input')).typeText('password123');
      
      // Hide keyboard
      await element(by.id('password-input')).tapReturnKey();
      
      // Tap login button
      await element(by.text('Login')).tap();
      
      // Verify navigation to welcome screen
      await waitFor(element(by.text('Welcome'))).toBeVisible().withTimeout(5000);
    });

    it('should show error for invalid credentials', async () => {
      await element(by.text('Patient')).tap();
      await element(by.id('email-input')).typeText('invalid@test.com');
      await element(by.id('password-input')).typeText('wrongpass');
      await element(by.id('password-input')).tapReturnKey();
      await element(by.text('Login')).tap();
      
      await waitFor(element(by.text(/invalid/i))).toBeVisible().withTimeout(3000);
    });
  });

  describe('Reminder Management', () => {
    beforeEach(async () => {
      // Login before each test
      await element(by.text('Patient')).tap();
      await element(by.id('email-input')).typeText('patient@test.com');
      await element(by.id('password-input')).typeText('password123');
      await element(by.id('password-input')).tapReturnKey();
      await element(by.text('Login')).tap();
      await waitFor(element(by.text('Welcome'))).toBeVisible().withTimeout(5000);
    });

    it('should navigate to reminders screen', async () => {
      await element(by.text('My Reminders')).tap();
      await expect(element(by.text('My Reminders'))).toBeVisible();
    });

    it('should create a new reminder', async () => {
      await element(by.text('My Reminders')).tap();
      await waitFor(element(by.id('add-reminder-button'))).toBeVisible().withTimeout(3000);
      
      await element(by.id('add-reminder-button')).tap();
      await expect(element(by.text('Create Reminder'))).toBeVisible();
      
      // Fill form
      await element(by.id('reminder-title-input')).typeText('Test Reminder');
      await element(by.id('reminder-description-input')).typeText('This is a test');
      
      // Save
      await element(by.text('Save')).tap();
      
      // Verify reminder appears
      await waitFor(element(by.text('Test Reminder'))).toBeVisible().withTimeout(3000);
    });

    it('should filter reminders by status', async () => {
      await element(by.text('My Reminders')).tap();
      await waitFor(element(by.id('add-reminder-button'))).toBeVisible().withTimeout(3000);
      
      // Tap on completed filter
      await element(by.text('Completed')).tap();
      
      // Should show completed reminders or empty state
      // This depends on data
    });

    it('should search for reminders', async () => {
      await element(by.text('My Reminders')).tap();
      await waitFor(element(by.id('search-input'))).toBeVisible().withTimeout(3000);
      
      await element(by.id('search-input')).typeText('medication');
      
      // Should filter results
      await waitFor(element(by.text(/medication/i))).toBeVisible().withTimeout(2000);
    });

    it('should mark reminder as completed', async () => {
      await element(by.text('My Reminders')).tap();
      await waitFor(element(by.id('add-reminder-button'))).toBeVisible().withTimeout(3000);
      
      // Find first complete button
      await element(by.id('complete-button')).atIndex(0).tap();
      
      // Should show success feedback
      await waitFor(element(by.text(/completed/i))).toBeVisible().withTimeout(2000);
    });

    it('should delete a reminder', async () => {
      await element(by.text('My Reminders')).tap();
      await waitFor(element(by.id('add-reminder-button'))).toBeVisible().withTimeout(3000);
      
      // Get initial reminder count
      const remindersBefore = await element(by.id('reminder-item'));
      
      // Find first delete button
      await element(by.id('delete-button')).atIndex(0).tap();
      
      // Confirm deletion if there's a confirmation dialog
      try {
        await element(by.text('Delete')).tap();
      } catch (e) {
        // No confirmation dialog
      }
      
      // Reminder should be removed
      await waitFor(element(by.id('reminder-item'))).not.toBeVisible().withTimeout(2000);
    });
  });

  describe('Appointment Booking', () => {
    beforeEach(async () => {
      // Login
      await element(by.text('Patient')).tap();
      await element(by.id('email-input')).typeText('patient@test.com');
      await element(by.id('password-input')).typeText('password123');
      await element(by.id('password-input')).tapReturnKey();
      await element(by.text('Login')).tap();
      await waitFor(element(by.text('Welcome'))).toBeVisible().withTimeout(5000);
    });

    it('should navigate to book appointment', async () => {
      await element(by.text('Book Appointment')).tap();
      await expect(element(by.text('Book an Appointment'))).toBeVisible();
    });

    it('should display available doctors', async () => {
      await element(by.text('Book Appointment')).tap();
      await waitFor(element(by.id('doctor-list'))).toBeVisible().withTimeout(5000);
      
      // Should show at least one doctor
      await expect(element(by.id('doctor-card')).atIndex(0)).toBeVisible();
    });
  });

  describe('Medical Cases', () => {
    beforeEach(async () => {
      // Login
      await element(by.text('Patient')).tap();
      await element(by.id('email-input')).typeText('patient@test.com');
      await element(by.id('password-input')).typeText('password123');
      await element(by.id('password-input')).tapReturnKey();
      await element(by.text('Login')).tap();
      await waitFor(element(by.text('Welcome'))).toBeVisible().withTimeout(5000);
    });

    it('should view medical cases', async () => {
      await element(by.text('My Cases')).tap();
      await expect(element(by.text('My Medical Cases'))).toBeVisible();
    });

    it('should create a new case', async () => {
      await element(by.text('My Cases')).tap();
      await waitFor(element(by.id('create-case-button'))).toBeVisible().withTimeout(3000);
      
      await element(by.id('create-case-button')).tap();
      await expect(element(by.text('Create New Case'))).toBeVisible();
    });
  });

  describe('Hardware Back Button (Android)', () => {
    it('should navigate back using hardware button', async () => {
      if (device.getPlatform() === 'android') {
        await element(by.text('Patient')).tap();
        await expect(element(by.text('Patient Login'))).toBeVisible();
        
        // Press hardware back button
        await device.pressBack();
        
        // Should return to role selection
        await expect(element(by.text('Select Your Role'))).toBeVisible();
      }
    });
  });

  describe('Offline Mode', () => {
    it('should show offline indicator when disconnected', async () => {
      // Disable network
      await device.setNetworkConditions('none');
      
      // Try to perform an action that requires network
      await element(by.text('Patient')).tap();
      await element(by.id('email-input')).typeText('patient@test.com');
      await element(by.id('password-input')).typeText('password123');
      await element(by.id('password-input')).tapReturnKey();
      await element(by.text('Login')).tap();
      
      // Should show offline message
      await waitFor(element(by.text(/offline/i))).toBeVisible().withTimeout(3000);
      
      // Re-enable network
      await device.setNetworkConditions('wifi');
    });
  });

  describe('Error Boundaries', () => {
    it('should handle errors gracefully', async () => {
      // This would require triggering an error in the app
      // For now, we just verify error boundary exists
      
      // If an error occurs, error boundary should catch it
      // and show fallback UI instead of crashing
    });
  });

  describe('Performance', () => {
    it('should load screens quickly', async () => {
      const startTime = Date.now();
      
      await element(by.text('Patient')).tap();
      await expect(element(by.text('Patient Login'))).toBeVisible();
      
      const loadTime = Date.now() - startTime;
      
      // Screen should load in under 1 second
      expect(loadTime).toBeLessThan(1000);
    });
  });
});
